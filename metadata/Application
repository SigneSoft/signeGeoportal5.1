{
    "type": "Ext.app.Application",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "controllers": [
            "controllerMapa"
        ],
        "models": [
            "modelParametro"
        ],
        "name": "signeGeoportal",
        "stores": [
            "storeCatalogo",
            "storeParametro"
        ],
        "views": [
            "Escritorio",
            "LegendPanel",
            "MapPanel",
            "Map",
            "ListaLayer",
            "InfoPanel",
            "ContentPanel",
            "VentanaParametro"
        ]
    },
    "name": "Application",
    "configAlternates": {
        "xMap": "object",
        "xLegend": "object",
        "xLayerStore": "object",
        "xInfo": "object",
        "xSlider": "object",
        "xTip": "object",
        "xClone": "object"
    },
    "designerId": "application",
    "customConfigs": [
        {
            "group": "(Custom Properties)",
            "name": "xMap",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "xLegend",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "xLayerStore",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "xInfo",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "xSlider",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "xTip",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "xClone",
            "type": "string"
        }
    ],
    "cn": [
        {
            "type": "Ext.Loader",
            "reference": {
                "name": "loader",
                "type": "object"
            },
            "codeClass": null,
            "userConfig": {
                "paths": [
                    " {GeoExt: '../geoext2210/src/GeoExt'}"
                ]
            },
            "name": "Loader6",
            "designerId": "9fe8fb09-ad11-4e4a-9295-fe16a39831f7"
        },
        {
            "type": "fixedfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "launch",
                "implHandler": [
                    "// Carga el listado de capas disponibles en el servidor",
                    "",
                    "var store = Ext.create('GeoExt.data.WmsCapabilitiesLayerStore', {",
                    "    storeId: 'wmscapsStore',",
                    "    //url: \"http://190.85.233.223:8080/geoserver/siceg/wms?service=wms&version=1.1.1&request=GetCapabilities\",",
                    "    url: \"http://192.168.56.101:8282/geoserver/SIGE/wms?service=wms&version=1.1.1&request=GetCapabilities\",",
                    "    autoLoad: true",
                    "});",
                    "",
                    "",
                    "var grid = Ext.ComponentQuery.query('listalayer')[0];",
                    "",
                    "grid.reconfigure(store);",
                    "",
                    "// Define y crea el panel de leyenda",
                    "",
                    "signeGeoportal.xLayerStore = Ext.create('Ext.data.TreeStore', {",
                    "    model: 'GeoExt.data.LayerTreeModel',",
                    "    root: {",
                    "        plugins: [{",
                    "            ptype: \"gx_overlaylayercontainer\",",
                    "            //ptype: \"gx_layercontainer\",",
                    "            /*loader: {",
                    "                createNode: function(attr) {",
                    "                    // add a WMS legend to each node created",
                    "                    attr.component = {",
                    "                        xtype: \"gx_wmslegend\",",
                    "                        layerRecord: signeGeoportal.xMap.layers.getByLayer(attr.layer),",
                    "                        showTitle: false,",
                    "                        // custom class for css positioning",
                    "                        // see tree-legend.html",
                    "                        cls: \"legend\"",
                    "                    };",
                    "                    return GeoExt.tree.LayerLoader.prototype.createNode.call(this, attr);",
                    "                }",
                    "            }*/",
                    "        }]",
                    "    }",
                    "});",
                    "",
                    "//*** Este código añade al panel el arbol que contiene los layers",
                    "var treeLayer = Ext.create('GeoExt.tree.Panel', {",
                    "    region: \"center\",",
                    "    autoScroll: true,",
                    "    id: 'treelayer',",
                    "    viewConfig: {",
                    "        plugins: [{",
                    "            ptype: 'treeviewdragdrop',",
                    "            appendOnly: false",
                    "        }]",
                    "    },",
                    "    store: signeGeoportal.xLayerStore,",
                    "    rootVisible: false,",
                    "    lines: false,",
                    "    listeners: {",
                    "        itemclick : function(view,rec,item,index,eventObj) {",
                    "            layer = signeGeoportal.getApplication().obtenerLayer();",
                    "            var slider = Ext.getCmp('slider');",
                    "            slider.setValue(layer.opacity * 100);",
                    "",
                    "        }",
                    "    }",
                    "});",
                    "",
                    "var contentpanel = Ext.ComponentQuery.query('contentpanel')[0];",
                    "contentpanel.add(treeLayer);",
                    "",
                    "/*var slider= new GeoExt.LayerOpacitySlider({",
                    "\t\t\t\t\tid:\"opacity_slider\",",
                    "\t\t\t\t\taggressive:true,",
                    "\t\t\t\t\tvertical:false,",
                    "\t\t\t\t\twidth:100,",
                    "\t\t\t\t\tvalue:70,",
                    "\t\t\t\t\tminValue:0,",
                    "\t\t\t\t\tmaxValue:100,",
                    "\t\t\t\t\tplugins: new GeoExt.LayerOpacitySliderTip() ,",
                    "\t\t\t\t\tlisteners:{change:function(slider,newValue,thumb) {",
                    "\t\t\t\t\t\t\t\t\t\t\t  var record = getRecordTree();",
                    "\t\t\t\t\t\t\t\t\t\t\t  if(record.layer)",
                    "\t\t\t\t\t\t\t\t\t\t\t     record.layer.setOpacity(newValue/100.0);",
                    "\t\t\t\t\t\t\t\t\t\t\t  }",
                    "",
                    "\t\t\t\t\t\t  }",
                    "\t\t\t\t\t  });*/",
                    "",
                    "var slider = Ext.create('GeoExt.slider.LayerOpacity', {",
                    "    id:'slider',",
                    "    aggressive: true,",
                    "    width: '100%',",
                    "    inverse: true,",
                    "    fieldLabel: \"Transparencia\",",
                    "    value:80,",
                    "    plugins: Ext.create(\"GeoExt.slider.Tip\", {",
                    "        getText: function(thumb) {",
                    "            return Ext.String.format('Transparencia: {0}%', thumb.value);",
                    "        }",
                    "    }),",
                    "    listeners:{change:function(slider,newValue,thumb) {",
                    "        var layer = signeGeoportal.getApplication().obtenerLayer();",
                    "        //console.log(layer);",
                    "        if(layer)",
                    "            layer.setOpacity(newValue/100.0);",
                    "    }",
                    "              }",
                    "});",
                    "",
                    "",
                    "var legendtool = Ext.getCmp('tbSlider');",
                    "legendtool.add(slider);",
                    "//legendtool.doLayout();*/",
                    "",
                    "//*** Este código añade al panel el arbol que contiene la leyenda",
                    "var legendLayer = Ext.create('GeoExt.panel.Legend',{",
                    "    region: \"center\",",
                    "    autoScroll: true,",
                    "    id: 'legendlayer',",
                    "    padding: '5 10 5 10',",
                    "    layerStore: signeGeoportal.xMap.layers",
                    "});",
                    "",
                    "var legendpanel = Ext.ComponentQuery.query('legendpanel')[0];",
                    "",
                    "",
                    "legendpanel.add(legendLayer);",
                    "",
                    "// Define y crea el panel de información",
                    "signeGeoportal.xInfo = new OpenLayers.Control.WMSGetFeatureInfo({",
                    "    //    autoActivate: true,",
                    "    //infoFormat: \"application/vnd.ogc.gml\",",
                    "    maxFeatures: 3,",
                    "    eventListeners: {",
                    "        beforegetfeatureinfo: function(event) {",
                    "            var retArray = [];",
                    "            var vParams = [];",
                    "            var layer;",
                    "",
                    "            for(var i=0;i<signeGeoportal.xMap.map.layers.length;i++)",
                    "            {",
                    "                layer = signeGeoportal.xMap.map.layers[i];",
                    "                if (layer.params){",
                    "                    if (layer.params.VIEWPARAMS){",
                    "                        vParams.push(layer.params.VIEWPARAMS);",
                    "                    }",
                    "                    else{",
                    "                        vParams.push('x:0'); // just to have something. Number of params must equal number of layers",
                    "                    }",
                    "                    retArray.push(layer);",
                    "",
                    "",
                    "                }",
                    "            }",
                    "",
                    "            // put view parameters into a string",
                    "            var viewparams = '';",
                    "            for (i=vParams.length-1; i>=0; i--){",
                    "                viewparams += vParams[i];",
                    "                viewparams += (i>0)? ',' : '';",
                    "            }",
                    "",
                    "            // add a buffer of 20 pixels around 'click' pluss the viewParams",
                    "            this.vendorParams = (vParams.length > 0)? {'buffer':5, 'viewParams': viewparams} : {buffer:5};",
                    "            // set the layers to be queried",
                    "            this.layers = retArray;",
                    "        },",
                    "        \"getfeatureinfo\": function(e) {",
                    "",
                    "            //console.log(e.text);",
                    "",
                    "            var items = [];",
                    "",
                    "            var infopanel = Ext.ComponentQuery.query('infopanel')[0];",
                    "",
                    "            infopanel.removeAll();",
                    "            //infopanel.remove('infogrid',false);",
                    "",
                    "            var propiedades = Ext.create('Ext.form.Panel', {",
                    "                //title: 'Simple Form',",
                    "                region: \"center\",",
                    "                autoScroll: true,",
                    "                padding: '5 10 5 10',",
                    "                html: e.text,",
                    "            });",
                    "",
                    "            items.push(propiedades);",
                    "",
                    "            infopanel.add(items);",
                    "",
                    "        }",
                    "    }",
                    "});",
                    "",
                    "signeGeoportal.xMap.map.addControl(signeGeoportal.xInfo);",
                    ""
                ]
            },
            "name": "launch",
            "designerId": "b043cf2f-eb12-433d-ad8d-a2143b8d4e82"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "titulo_capa, url_capa, nombre_capa, clone",
                    "parametros",
                    "texto"
                ],
                "fn": "aniadirCapa",
                "implHandler": [
                    "console.log(parametros);",
                    "",
                    "if (!parametros){",
                    "    var wms = new OpenLayers.Layer.WMS(",
                    "        clone.title,",
                    "        clone.url,",
                    "        {layers:clone.name,",
                    "         transparent : 'true',",
                    "         format: 'image/png'",
                    "        },",
                    "        {opacity: 0.7,",
                    "         isBaseLayer: false,",
                    "         //displayInLayerSwitcher:false",
                    "         //     attribution: \"<img src='\"+url_capa+\"request=GetLegendGraphic&format=image/png&width=18&height=17&layer=\"+nombre_capa+\"&legend_options=fontName:Times%20New%20Roman;fontAntiAliasing:true;fontColor:0x000033;fontSize:12;bgColor:0xFFFFEE;dpi:180'>\"",
                    "        }",
                    "    );",
                    "",
                    "    signeGeoportal.xMap.map.addLayer(wms);",
                    "}else{",
                    "",
                    "",
                    "    var wms = new OpenLayers.Layer.WMS(",
                    "        clone.title + \" \" + texto,",
                    "        clone.url,",
                    "        {layers:clone.name,",
                    "         transparent : 'true',",
                    "         format: 'image/png',",
                    "         viewparams: parametros,",
                    "        },",
                    "        {opacity: 0.7,",
                    "         isBaseLayer: false",
                    "         //displayInLayerSwitcher:false",
                    "         //     attribution: \"<img src='\"+url_capa+\"request=GetLegendGraphic&format=image/png&width=18&height=17&layer=\"+nombre_capa+\"&legend_options=fontName:Times%20New%20Roman;fontAntiAliasing:true;fontColor:0x000033;fontSize:12;bgColor:0xFFFFEE;dpi:180'>\"",
                    "        }",
                    "    );",
                    "",
                    "    signeGeoportal.xMap.map.addLayer(wms);",
                    "}",
                    "",
                    ""
                ]
            },
            "name": "aniadirCapa",
            "designerId": "a1340267-0c8f-40c7-be26-da70db6ec608"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "obtenerLayer",
                "implHandler": [
                    "var arbolCapa = Ext.getCmp(\"treelayer\");",
                    "record = arbolCapa.getSelectionModel().getSelection()[0];",
                    "layer = signeGeoportal.xMap.map.getLayer(record.data.layer.id);",
                    "",
                    "return layer;",
                    "//alert(\"func cambiando opacidad\");",
                    "",
                    ""
                ]
            },
            "name": "obtenerLayer",
            "designerId": "88c0be0f-4510-4b7f-9798-4176aae4add5"
        }
    ]
}